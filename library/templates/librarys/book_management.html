{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书管理 - 智慧图书馆系统</title>
    <link rel="stylesheet" href="{% static 'librarys/visualization.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-brand">
                <h1>智慧图书管理系统</h1>
            </div>
            <div class="nav-links">
                <a href="{% url 'dashboard' %}" class="nav-link">首页</a>
                <a href="{% url 'book_management' %}" class="nav-link active">图书管理</a>
                <a href="{% url 'author_list' %}" class="nav-link">作者管理</a>
                <a href="{% url 'borrow_records' %}" class="nav-link">借阅记录</a>
            </div>
            <div class="nav-auth">
                {% if user.is_authenticated %}
                    <span class="user-info">欢迎, {{ user.username }}</span>
                    <a href="{% url 'user_logout' %}" class="btn btn-outline">退出</a>
                {% else %}
                    <a href="{% url 'user_login' %}" class="btn btn-outline">登录</a>
                    <a href="{% url 'user_register' %}" class="btn btn-primary">注册</a>
                {% endif %}
            </div>
        </nav>

        <!-- 消息提示 -->
        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- 页面标题和操作按钮 -->
        <div class="page-header">
            <h2>图书管理</h2>
            <div class="header-actions">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                    添加新书
                </button>
            </div>
        </div>

        <!-- 搜索和筛选栏 -->
        <div class="filter-bar">
            <form method="GET" action="{% url 'book_management' %}" class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="搜索图书名称、作者或ISBN..."
                               name="search" value="{{ search_query|default:'' }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            搜索
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="category" onchange="this.form.submit()">
                        <option value="">所有分类</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}" {% if selected_category == category.name %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'book_management' %}" class="btn btn-outline-secondary">
                        重置筛选
                    </a>
                </div>
            </form>
        </div>

        <!-- 图书表格 -->
        <div class="content-card">
            <div class="card-header">
                <h3>图书列表</h3>
                <span class="badge">{{ books|length }} 本图书</span>
            </div>
            <div class="card-content">
                {% if books %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>书名</th>
                                <th>作者</th>
                                <th>分类</th>
                                <th>出版社</th>
                                <th>ISBN</th>
                                <th>出版日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for book in books %}
                            <tr>
                                <td>
                                    <strong>{{ book.title }}</strong>
                                </td>
                                <td>{{ book.author.name }}</td>
                                <td>
                                    <span class="badge bg-info">{{ book.category.name }}</span>
                                </td>
                                <td>{{ book.publisher.name }}</td>
                                <td>
                                    {% if book.isbn %}
                                    <code>{{ book.isbn }}</code>
                                    {% else %}
                                    <span class="text-muted">未设置</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if book.publish_date %}
                                    {{ book.publish_date|date:"Y-m-d" }}
                                    {% else %}
                                    <span class="text-muted">未知</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editBookModal"
                                                data-book-id="{{ book.id }}"
                                                data-book-title="{{ book.title }}"
                                                data-book-author="{{ book.author.name }}"
                                                data-book-category="{{ book.category.name }}"
                                                data-book-publisher="{{ book.publisher.name }}"
                                                data-book-isbn="{{ book.isbn|default:'' }}"
                                                data-book-publish-date="{{ book.publish_date|date:'Y-m-d'|default:'' }}">
                                            编辑
                                        </button>
                                        <button class="btn btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteBookModal"
                                                data-book-id="{{ book.id }}"
                                                data-book-title="{{ book.title }}">
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <h4>暂无图书数据</h4>
                    <p>点击"添加新书"按钮开始添加图书</p>
                </div>
                {% endif %}
            </div>
        </div>

        <footer>
            <p>智慧图书馆管理系统 &copy; 2025 | 共管理 <span class="highlight">{{ books|length }}</span> 本图书</p>
        </footer>
    </div>

    <!-- 添加图书模态框 -->
    <div class="modal fade" id="addBookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新书</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'add_book' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">书名</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">作者</label>
                            <input type="text" class="form-control" name="author" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-control" name="category" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">出版社</label>
                            <input type="text" class="form-control" name="publisher" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" name="isbn">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">出版日期</label>
                            <input type="date" class="form-control" name="publish_date">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">添加图书</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑图书模态框 -->
    <div class="modal fade" id="editBookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑图书信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="" id="editBookForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="book_id" id="editBookId">
                        <div class="mb-3">
                            <label class="form-label">书名</label>
                            <input type="text" class="form-control" name="title" id="editBookTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">作者</label>
                            <input type="text" class="form-control" name="author" id="editBookAuthor" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-control" name="category" id="editBookCategory" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">出版社</label>
                            <input type="text" class="form-control" name="publisher" id="editBookPublisher" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" name="isbn" id="editBookIsbn">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">出版日期</label>
                            <input type="date" class="form-control" name="publish_date" id="editBookPublishDate">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">保存更改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteBookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="" id="deleteBookForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>确定要删除图书《<span id="deleteBookTitle"></span>》吗？此操作不可逆。</p>
                        <input type="hidden" name="book_id" id="deleteBookId">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-danger">确认删除</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('图书管理页面已加载');

            // 编辑模态框数据填充
            const editModal = document.getElementById('editBookModal');
            editModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-book-id');
                const bookTitle = button.getAttribute('data-book-title');
                const bookAuthor = button.getAttribute('data-book-author');
                const bookCategory = button.getAttribute('data-book-category');
                const bookPublisher = button.getAttribute('data-book-publisher');
                const bookIsbn = button.getAttribute('data-book-isbn');
                const bookPublishDate = button.getAttribute('data-book-publish-date');

                document.getElementById('editBookId').value = bookId;
                document.getElementById('editBookTitle').value = bookTitle;
                document.getElementById('editBookAuthor').value = bookAuthor;
                document.getElementById('editBookCategory').value = bookCategory;
                document.getElementById('editBookPublisher').value = bookPublisher;
                document.getElementById('editBookIsbn').value = bookIsbn;
                document.getElementById('editBookPublishDate').value = bookPublishDate;

                // 设置表单action
                document.getElementById('editBookForm').action = `/books/${bookId}/edit/`;
            });

            // 删除确认模态框数据填充
            const deleteModal = document.getElementById('deleteBookModal');
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-book-id');
                const bookTitle = button.getAttribute('data-book-title');

                document.getElementById('deleteBookId').value = bookId;
                document.getElementById('deleteBookTitle').textContent = bookTitle;

                // 设置表单action
                document.getElementById('deleteBookForm').action = `/books/${bookId}/delete/`;
            });

            // 自动关闭消息提示
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });

            // 表格行悬停效果
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });

                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });

            // 搜索框实时筛选功能
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const rows = document.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(searchTerm) || searchTerm === '') {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }

            console.log('图书管理页面初始化完成');
        });
    </script>
</body>
</html>